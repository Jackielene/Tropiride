import{u as F,r,j as e,H,L as I}from"./app-DATJSk02.js";import{T as O}from"./tropiride-layout-Ymu0hBI5.js";import{C as f,a as y,b as S,c as C,d as M}from"./card-B1S1KxgK.js";import{A as $,a as U,b as X}from"./ErrorBoundary-C5KTbpzX.js";import{B as A}from"./button-Cpvsye0R.js";import{B as W}from"./badge-DjzpHOc_.js";import{M as j}from"./message-square-CsFWhGY6.js";import{L as T}from"./loader-circle-C04xZSrL.js";import{M as Y}from"./map-pin-BF5AnyJa.js";/* empty css            */import"./TropirideNavbar-Bqwvj4og.js";import"./index-BDq81tgb.js";import"./index-P1d-VrM6.js";import"./index-Cb992pyu.js";import"./index-Bs5OsWqX.js";import"./clsx-B-dksMZM.js";import"./createLucideIcon-CWJud2Xx.js";function oe({bookings:i,initialBookingId:x}){const{auth:B}=F().props,E=B.user?.id,[t,u]=r.useState(x),[h,p]=r.useState([]),[v,N]=r.useState(""),[L,b]=r.useState(!1),[g,w]=r.useState(!1),[_,o]=r.useState(null),R=typeof document<"u"?document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"":"",m=r.useRef(null),a=r.useMemo(()=>t&&i.find(s=>s.chat_booking_id===t)||null,[i,t]);r.useEffect(()=>{if(!t){p([]);return}let s=!0;const n=(d=!1)=>{d||(b(!0),o(null)),fetch(`/chat/bookings/${t}/messages`,{headers:{Accept:"application/json"},credentials:"same-origin"}).then(l=>{if(!l.ok)throw new Error("Failed to load messages");return l.json()}).then(l=>{s&&p(l.messages??[])}).catch(l=>{console.error(l),s&&(d||o("We could not load your messages. Please try again."))}).finally(()=>{s&&(d||b(!1))})};n();const c=setInterval(()=>n(!0),5e3);return()=>{s=!1,clearInterval(c)}},[t]),r.useEffect(()=>{m.current&&(m.current.scrollTop=m.current.scrollHeight)},[h]),r.useEffect(()=>{if(!i.length){u(null);return}(!t||!i.some(s=>s.chat_booking_id===t))&&u(x??i[0].chat_booking_id)},[i,t,x]);const k=async s=>{if(s.preventDefault(),!t||g)return;const n=v.trim();if(n){w(!0),o(null);try{const c=await fetch(`/chat/bookings/${t}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":R,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin",body:JSON.stringify({message:n})});if(!c.ok)throw new Error("Failed to send message");const d=await c.json();d.message&&p(l=>[...l,d.message]),N("")}catch(c){console.error(c),o("Unable to send your message. Please try again.")}finally{w(!1)}}},P=s=>new Date(s).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),q=s=>{switch(s){case"completed":return"default";case"pending":return"secondary";case"in_progress":return"outline";case"cancelled":return"destructive";default:return"outline"}},D=s=>{const n=s.chat_booking_id===t;return e.jsxs("button",{onClick:()=>u(s.chat_booking_id),className:`w-full border rounded-xl p-4 text-left transition hover:border-cyan-400 ${n?"border-cyan-500 shadow-lg shadow-cyan-500/10 bg-cyan-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:["Booking #",s.latest_booking_id]}),e.jsx(W,{variant:q(s.status),className:"text-[10px] capitalize",children:s.status.replace("_"," ")})]}),e.jsxs("p",{className:"text-xs text-gray-600 flex items-center gap-1 truncate",children:[e.jsx(Y,{className:"h-3 w-3 text-cyan-500"}),s.pickup_location]}),e.jsx("p",{className:"text-xs text-gray-500 ml-4 truncate",children:s.dropoff_location}),s.driver&&e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Driver: ",s.driver.name]})]},s.chat_booking_id)};return e.jsxs(O,{children:[e.jsx(H,{title:"Messages - Tropiride"}),e.jsx("section",{className:"bg-gradient-to-b from-cyan-50 to-white py-12",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-cyan-600 uppercase tracking-wide",children:"Messaging Hub"}),e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-900 mt-2",children:"Stay Connected with Your Driver"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Once a driver accepts your ride, you can coordinate trip details here in real time."})]})}),i.length===0?e.jsx(f,{className:"border-dashed border-2 border-gray-200 text-center py-16",children:e.jsxs(y,{className:"space-y-4",children:[e.jsx(j,{className:"h-12 w-12 text-gray-400 mx-auto"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-800",children:"No active conversations yet"}),e.jsx("p",{className:"text-gray-500 max-w-md mx-auto",children:"Request a ride first. Once a driver accepts, we’ll automatically open a chat for both of you."}),e.jsx(A,{asChild:!0,className:"bg-gradient-to-r from-cyan-500 to-blue-600",children:e.jsx(I,{href:"/tropiride/vehicles",children:"Request a Ride"})})]})}):e.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs(f,{children:[e.jsxs(S,{children:[e.jsx(C,{children:"Bookings"}),e.jsx(M,{children:"Select a ride to view its chat room"})]}),e.jsx(y,{className:"space-y-3",children:i.map(s=>D(s))})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(f,{className:"h-full",children:[e.jsxs(S,{children:[e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(j,{className:"h-5 w-5 text-cyan-600"}),"Conversation"]}),e.jsx(M,{children:"You’re connected directly with your assigned driver for this booking."})]}),e.jsxs(y,{className:"space-y-4",children:[a&&a.driver&&e.jsxs("div",{className:"border rounded-xl p-4 bg-gradient-to-r from-blue-50 to-cyan-50 flex items-center gap-4",children:[e.jsxs($,{className:"h-14 w-14 border-2 border-cyan-200",children:[e.jsx(U,{src:a.driver.avatar_url,alt:a.driver.name}),e.jsx(X,{children:(a.driver.name||"Driver").split(" ").map(s=>s[0]).join("").slice(0,2).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:a.driver.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Age: ",a.driver.age??"N/A"," · ",a.driver.address||"Address not set"]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Phone: ",a.driver.phone||"Not provided"]})]})]}),_&&e.jsx("div",{className:"text-sm text-red-600 bg-red-50 border border-red-100 rounded-md py-2 px-3",children:_}),e.jsx("div",{ref:m,className:"h-80 overflow-y-auto rounded-xl border bg-white shadow-inner p-4 space-y-3",children:L?e.jsxs("div",{className:"flex items-center justify-center h-full text-gray-500",children:[e.jsx(T,{className:"h-5 w-5 animate-spin mr-2"}),"Loading conversation..."]}):h.length===0?e.jsx("p",{className:"text-center text-gray-500 mt-10",children:"Send a message to greet your driver and confirm details."}):h.map(s=>{const n=s.sender_id===E,c=s.is_system?"bg-emerald-50 text-emerald-900":n?"bg-gradient-to-r from-cyan-500 to-blue-600 text-white":"bg-gray-100 text-gray-900";return e.jsxs("div",{className:`flex flex-col ${n?"items-end text-right":"items-start"}`,children:[e.jsx("div",{className:`px-4 py-2 rounded-2xl max-w-[85%] shadow-sm ${c}`,children:s.message}),e.jsxs("span",{className:"text-[10px] text-gray-500 mt-1",children:[s.sender_name," · ",s.created_at?P(s.created_at):""]})]},s.id)})}),a&&e.jsxs("form",{className:"space-y-2",onSubmit:k,children:[e.jsx("textarea",{rows:3,value:v,onChange:s=>N(s.target.value),className:"w-full rounded-xl border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400",placeholder:"Send a note to your driver..."}),e.jsx("div",{className:"flex justify-end",children:e.jsx(A,{type:"submit",disabled:g,className:"gap-2",children:g?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4 animate-spin"}),"Sending"]}):e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"h-4 w-4"}),"Send Message"]})})})]})]})]})})]})]})})]})}export{oe as default};
