import{u as Y,r as a,j as e,H as V,L as W,a as A}from"./app-D2KhOlPS.js";import{T as G}from"./tropiride-layout-CF6aPqTO.js";import{C as N,a as w,b as E,c as L,d as T}from"./card-CTMh3Ccf.js";import{A as J,a as K,b as Q}from"./ErrorBoundary-DhJ2_a8D.js";import{B as h}from"./button-DRgzOgcv.js";import{B as X}from"./badge-C9baLLyP.js";import{a as D}from"./axios-BqQSuAxk.js";import{M as _}from"./message-square-B3ZYgRdM.js";import{L as k}from"./loader-circle-BaJ-6V5O.js";import{R as P}from"./refresh-cw-CLC0BXjc.js";import{M as Z}from"./map-pin-BuTsegXW.js";/* empty css            */import"./TropirideNavbar-CCjgeLIB.js";import"./index-CXP4cl-V.js";import"./index-6XFs-mRv.js";import"./index-D5JU00dO.js";import"./index-BHDVE5T7.js";import"./clsx-B-dksMZM.js";import"./createLucideIcon-EMwdt5a8.js";function ye({bookings:u,initialBookingId:g}){const{auth:$}=Y().props,H=$.user?.id,[n,p]=a.useState(u),[r,o]=a.useState(g);a.useEffect(()=>{p(u)},[u]);const[f,j]=a.useState([]),[S,C]=a.useState(""),[F,y]=a.useState(!1),[v,B]=a.useState(!1),[d,M]=a.useState(!1),[R,m]=a.useState(null),x=a.useRef(null);a.useEffect(()=>{const t=setInterval(()=>{A.reload({only:["bookings","initialBookingId"],onSuccess:c=>{const l=c.props.bookings||[];p(l),n.length===0&&l.length>0&&o(l[0].chat_booking_id)}})},1e4);return()=>clearInterval(t)},[n.length]);const I=()=>{M(!0),A.reload({only:["bookings","initialBookingId"],onSuccess:s=>{const t=s.props.bookings||[];p(t),n.length===0&&t.length>0&&o(t[0].chat_booking_id)},onFinish:()=>M(!1)})},i=a.useMemo(()=>r&&n.find(s=>s.chat_booking_id===r)||null,[n,r]);a.useEffect(()=>{if(!r){j([]);return}let s=!0;const t=async(l=!1)=>{l||(y(!0),m(null));try{const b=await D.get(`/chat/bookings/${r}/messages`);if(!s)return;j(b.data.messages??[])}catch(b){if(console.error(b),!s)return;l||m("We could not load your messages. Please try again.")}finally{!s&&!l&&y(!1),s&&!l&&y(!1)}};t();const c=setInterval(()=>t(!0),5e3);return()=>{s=!1,clearInterval(c)}},[r]),a.useEffect(()=>{x.current&&(x.current.scrollTop=x.current.scrollHeight)},[f]),a.useEffect(()=>{if(!n.length){o(null);return}(!r||!n.some(s=>s.chat_booking_id===r))&&o(g??n[0].chat_booking_id)},[n,r,g]);const q=async s=>{if(s.preventDefault(),!r||v)return;const t=S.trim();if(t){B(!0),m(null);try{const c=await D.post(`/chat/bookings/${r}/messages`,{message:t});c.data.message&&j(l=>[...l,c.data.message]),C("")}catch(c){console.error(c),m("Unable to send your message. Please try again.")}finally{B(!1)}}},O=s=>new Date(s).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),U=s=>{switch(s){case"completed":return"default";case"pending":return"secondary";case"in_progress":return"outline";case"cancelled":return"destructive";default:return"outline"}},z=s=>{const t=s.chat_booking_id===r;return e.jsxs("button",{onClick:()=>o(s.chat_booking_id),className:`w-full border rounded-xl p-4 text-left transition hover:border-cyan-400 ${t?"border-cyan-500 shadow-lg shadow-cyan-500/10 bg-cyan-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:["Booking #",s.latest_booking_id]}),e.jsx(X,{variant:U(s.status),className:"text-[10px] capitalize",children:s.status.replace("_"," ")})]}),e.jsxs("p",{className:"text-xs text-gray-600 flex items-center gap-1 truncate",children:[e.jsx(Z,{className:"h-3 w-3 text-cyan-500"}),s.pickup_location]}),e.jsx("p",{className:"text-xs text-gray-500 ml-4 truncate",children:s.dropoff_location}),s.driver&&e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Driver: ",s.driver.name]})]},s.chat_booking_id)};return e.jsxs(G,{children:[e.jsx(V,{title:"Messages - Tropiride"}),e.jsx("section",{className:"bg-gradient-to-b from-cyan-50 to-white py-12",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-cyan-600 uppercase tracking-wide",children:"Messaging Hub"}),e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-gray-900 mt-2",children:"Stay Connected with Your Driver"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Once a driver accepts your ride, you can coordinate trip details here in real time."})]})}),n.length===0?e.jsx(N,{className:"border-dashed border-2 border-gray-200 text-center py-16",children:e.jsxs(w,{className:"space-y-4",children:[e.jsx(_,{className:"h-12 w-12 text-gray-400 mx-auto"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-800",children:"No active conversations yet"}),e.jsx("p",{className:"text-gray-500 max-w-md mx-auto",children:"Request a ride first. Once a driver accepts, a chat will automatically appear here."}),e.jsx("p",{className:"text-sm text-gray-400",children:"This page refreshes automatically every 10 seconds."}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsx(h,{asChild:!0,className:"bg-gradient-to-r from-cyan-500 to-blue-600",children:e.jsx(W,{href:"/tropiride/vehicles",children:"Request a Ride"})}),e.jsxs(h,{variant:"outline",onClick:I,disabled:d,children:[d?e.jsx(k,{className:"h-4 w-4 animate-spin"}):e.jsx(P,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-2",children:"Refresh"})]})]})]})}):e.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs(N,{children:[e.jsx(E,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(L,{children:"Bookings"}),e.jsx(T,{children:"Select a ride to view its chat room"})]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:I,disabled:d,title:"Refresh bookings",children:e.jsx(P,{className:`h-4 w-4 ${d?"animate-spin":""}`})})]})}),e.jsx(w,{className:"space-y-3",children:n.map(s=>z(s))})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(N,{className:"h-full",children:[e.jsxs(E,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-5 w-5 text-cyan-600"}),"Conversation"]}),e.jsx(T,{children:"You’re connected directly with your assigned driver for this booking."})]}),e.jsxs(w,{className:"space-y-4",children:[i&&i.driver&&e.jsxs("div",{className:"border rounded-xl p-4 bg-gradient-to-r from-blue-50 to-cyan-50 flex items-center gap-4",children:[e.jsxs(J,{className:"h-14 w-14 border-2 border-cyan-200",children:[e.jsx(K,{src:i.driver.avatar_url,alt:i.driver.name}),e.jsx(Q,{children:(i.driver.name||"Driver").split(" ").map(s=>s[0]).join("").slice(0,2).toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:i.driver.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Age: ",i.driver.age??"N/A"," · ",i.driver.address||"Address not set"]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Phone: ",i.driver.phone||"Not provided"]})]})]}),R&&e.jsx("div",{className:"text-sm text-red-600 bg-red-50 border border-red-100 rounded-md py-2 px-3",children:R}),e.jsx("div",{ref:x,className:"h-80 overflow-y-auto rounded-xl border bg-white shadow-inner p-4 space-y-3",children:F?e.jsxs("div",{className:"flex items-center justify-center h-full text-gray-500",children:[e.jsx(k,{className:"h-5 w-5 animate-spin mr-2"}),"Loading conversation..."]}):f.length===0?e.jsx("p",{className:"text-center text-gray-500 mt-10",children:"Send a message to greet your driver and confirm details."}):f.map(s=>{const t=s.sender_id===H,c=s.is_system?"bg-emerald-50 text-emerald-900":t?"bg-gradient-to-r from-cyan-500 to-blue-600 text-white":"bg-gray-100 text-gray-900";return e.jsxs("div",{className:`flex flex-col ${t?"items-end text-right":"items-start"}`,children:[e.jsx("div",{className:`px-4 py-2 rounded-2xl max-w-[85%] shadow-sm ${c}`,children:s.message}),e.jsxs("span",{className:"text-[10px] text-gray-500 mt-1",children:[s.sender_name," · ",s.created_at?O(s.created_at):""]})]},s.id)})}),i&&e.jsxs("form",{className:"space-y-2",onSubmit:q,children:[e.jsx("textarea",{rows:3,value:S,onChange:s=>C(s.target.value),className:"w-full rounded-xl border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400",placeholder:"Send a note to your driver..."}),e.jsx("div",{className:"flex justify-end",children:e.jsx(h,{type:"submit",disabled:v,className:"gap-2",children:v?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"h-4 w-4 animate-spin"}),"Sending"]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-4 w-4"}),"Send Message"]})})})]})]})]})})]})]})})]})}export{ye as default};
